280-[SF]-Lab - Firewall Malware
Malware Protection Using an AWS Network Firewall

Lab Overview

Malware, short for malicious software, refers to intrusive software developed by cybercriminals to steal data and damage or destroy computer systems. Common types include viruses, worms, Trojan horses, spyware, adware, and ransomware. Firewalls act as a security barrier between an organization's internal network and external networks like the internet, protecting against unauthorized access.

In this lab, you address malware threats by configuring an AWS Network Firewall to block access to malicious websites. You will work in a pre-configured lab environment with a Testinstance (Amazon EC2) in a perimeter zone, separated from critical servers, to test and secure the network.

Scenario

You are a security engineer at Anycompany, tasked with hardening the company's security perimeter. Reports indicate users have downloaded malware from specific websites. The IT team has provided the URLs hosting the malware, and your job is to configure the network firewall to block access to these malicious files.

Objectives

By completing this lab, you will be able to:





Update a network firewall.



Create a firewall rules group.



Verify and test that access to malicious sites is blocked.

Duration

Approximately 45 minutes.

Lab Environment

The lab includes a pre-configured Amazon EC2 Testinstance for testing access to malicious files. You will update the Anycompany network firewall, create a rules group, attach it to a firewall policy, and test the remediation. All backend components (EC2, IAM roles, and AWS services) are pre-configured.

Tasks

Task 1: Confirm Reachability

In this task, you log into the pre-configured Testinstance EC2 instance and use the wget command to confirm access to the malicious URLs provided by the IT team.





From the Vocareum console, select AWS Details and copy the TestinstanceURL link into a new browser tab to log into the Testinstance via AWS Systems Manager Session Manager.



Run the following commands to navigate and verify the current directory:

cd ~
pwd



Simulate downloading malicious files using the wget command in the protected lab environment:

wget http://malware.wicar.org/data/js_crypto_miner.html
wget http://malware.wicar.org/data/java_jre17_exec.html

Note: These files are designed for anti-malware testing and should not be used outside this lab.



Verify the files were downloaded using:

ls

Expected output includes java_jre17_exec.html and js_crypto_miner.html.

Summary: You confirmed that the malicious URLs are accessible through the current network firewall setup.

Task 2: Inspect the Network Firewall

In this task, you inspect and update the pre-configured AWS Network Firewall.





In the AWS Management Console, search for VPC and select it.



Navigate to NETWORK FIREWALL > Firewalls and select Labfirewall.



In Step 2: Configure the firewall policy, select the LabfirewallPolicy link.



In the Stateless default actions section, choose Edit and configure:





Choose how to treat fragmented packets: Select Use the same actions for all packets.



Action: Select Forward to stateful rule groups.



Choose Save.

Summary: You updated the firewall policy to forward all packets for stateful rule inspection.

Task 3: Create a Firewall Rule Group

In this task, you create a stateful firewall rule group to block the malicious URLs.





Navigate to NETWORK FIREWALL > Network Firewall Rule Groups and select Create Network Firewall rule group.



Configure the rule group:





Rule group type: Select Stateful rule group.



Rule group format: Select Suricata compatible rule string.



Rule evaluation order: Select Action order.



Choose Next.



In Rule group details, configure:





Name: StatefulRuleGroup



Capacity: 100



Choose Next.



In the Suricata compatible IPS rules section, add the following rules:

drop http $HOME_NET any -> $EXTERNAL_NET 80 (
    msg:"MALWARE custom solution";
    flow:to_server,established;
    classtype:trojan-activity;
    sid:2002001;
    content:"/data/js_crypto_miner.html";
    http_uri;
    rev:1;
)
drop http $HOME_NET any -> $EXTERNAL_NET 80 (
    msg:"MALWARE custom solution";
    flow:to_server,established;
    classtype:trojan-activity;
    sid:2002002;
    content:"/data/java_jre17_exec.html";
    http_uri;
    rev:1;
)



Choose Next until the Review and create section, then select Create stateful rule group.

Summary: You created a stateful rule group using Suricata rules to block the malicious URLs.

Task 4: Attach a Rule Group to the Network Firewall

In this task, you attach the rule group to the firewall.





Navigate to NETWORK FIREWALL > Firewalls and select Labfirewall.



Under Associated firewall policy, select LabfirewallPolicy.



In Stateful rule groups, choose Add unmanaged stateful rule groups, select StatefulRuleGroup, and choose Add stateful rule group.



Verify the update with the green You successfully updated FirewallPolicy banner.



Check the Stateful rule groups section to confirm the rule group was added.

Summary: You attached the rule group to the firewall to block access to the malicious URLs.

Task 5: Validate the Solution

In this task, you verify that the firewall blocks access to the malicious URLs.





In the AWS Management Console, search for EC2 and select it.



Navigate to Instances, select Testinstance, and choose Connect via the Session Manager tab.



Run the following commands to navigate and verify the directory:

cd ~
pwd



Test access to the malicious URLs:

wget http://malware.wicar.org/data/js_crypto_miner.html

Expected output: HTTP request sent, awaiting response... (indicating the site is blocked).



Stop the command with Ctrl+C.



Test the second URL:

wget http://malware.wicar.org/data/java_jre17_exec.html

Expected output: HTTP request sent, awaiting response... (indicating the site is blocked).



Remove the test malware files:

rm java_jre17_exec.html js_crypto_miner.html



Confirm file deletion:

ls

Expected output: Blank, confirming files are removed.

Summary: You verified that the firewall blocks access to the malicious URLs.

Conclusion

You successfully:





Updated the AWS Network Firewall.



Created a stateful firewall rule group.



Verified that access to malicious sites is blocked.

Cleanup





In the Vocareum console, select End Lab and confirm with Yes.



Verify the Ended AWS Lab Successfully message.
